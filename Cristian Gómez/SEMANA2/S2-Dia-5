-- HE DECIDIDO CALCULAR CADA PARTE POR SEPARADO PARA EVITAR DUPLICADOS EN FUNCIONES COUNT AL SEPARAR UNA FILA EN VARIAS --
-- CONTEO DE INGREDIENTES BASE DE CADA PIZZA ENVIADA --
WITH TempIngredientes as (
    SELECT 
        PT.TOPPING_NAME
        ,PT.TOPPING_ID
        ,COUNT(VALUE::STRING) AS CONTEO_INGREDIENTES
    FROM PIZZA_RECIPES PR
    JOIN LATERAL FLATTEN(SPLIT(PR.TOPPINGS, ', ')) AS EXT 
    LEFT JOIN PIZZA_TOPPINGS PT 
        ON EXT.VALUE::STRING = PT.TOPPING_ID
    LEFT JOIN CUSTOMER_ORDERS C 
        ON C.PIZZA_ID = PR.PIZZA_ID
    LEFT JOIN RUNNER_ORDERS RO 
        ON RO.ORDER_ID = C.ORDER_ID
    WHERE COALESCE(RO.CANCELLATION, '') NOT IN ('Restaurant Cancellation','Customer Cancellation')
    GROUP BY 1, 2
),
-- CONTEO DE INGREDIENTES EXTRA AÑADIDOS --
TempExtras as (
    SELECT
        AUX1.EXTRAS
        , COUNT(AUX1.EXTRAS) AS CONTEO_EXTRAS
    FROM (
        SELECT
            C.ORDER_ID
            , C.PIZZA_ID
            --, PT.TOPPING_NAME
            , REPLACE((VALUE::STRING), 'null', '') AS EXTRAS
        FROM CUSTOMER_ORDERS C
        JOIN LATERAL FLATTEN(SPLIT(C.EXTRAS, ', ')) 
        JOIN RUNNER_ORDERS RO
            ON RO.ORDER_ID = C.ORDER_ID
        --RIGHT JOIN PIZZA_TOPPINGS PT
            --ON PT.TOPPING_ID = EXTRAS
        WHERE COALESCE(RO.CANCELLATION, '') NOT IN ('Restaurant Cancellation','Customer Cancellation')
        ) AS AUX1
    GROUP BY 1
),
-- CONTEO DE INGREDIENTES EXCLUIDOS -- 
TempExclusions as (
    SELECT
        AUX2.EXCLUSIONS
        , COUNT(AUX2.EXCLUSIONS) AS CONTEO_EXCLUSIONS
    FROM (     
        SELECT
            C.ORDER_ID
            , C.PIZZA_ID
            , EXC.VALUE::STRING AS EXCLUSIONS_0
            , NULLIF(REPLACE(REPLACE(EXCLUSIONS_0, 'beef', 3), 'null',''), '') AS EXCLUSIONS -- NO ES LO IDEAL PORQUE SOLO SIRVE CON BEEF Y NO CUALQUIER INGREDIENTE
            --, PT.TOPPING_NAME
        FROM CUSTOMER_ORDERS C
        JOIN LATERAL FLATTEN(SPLIT(C.EXCLUSIONS, ', ')) AS EXC
        JOIN RUNNER_ORDERS RO
            ON RO.ORDER_ID = C.ORDER_ID
        --RIGHT JOIN PIZZA_TOPPINGS PT
            --ON EXCLUSIONS = PT.TOPPING_ID
        WHERE COALESCE(RO.CANCELLATION, '') NOT IN ('Restaurant Cancellation','Customer Cancellation')
        ) AS AUX2
    GROUP BY 1
)
SELECT
    TempIngredientes.TOPPING_NAME
    , TempIngredientes.CONTEO_INGREDIENTES+TempExtras.CONTEO_EXTRAS-TempExclusions.CONTEO_EXCLUSIONS
FROM TempIngredientes
LEFT JOIN TempExtras
    ON TempIngredientes.TOPPING_ID = TempExtras.EXTRAS
LEFT JOIN TempExclusions
    ON TempIngredientes.TOPPING_ID = TempExclusions.EXCLUSIONS;

--ESTÁ INACABADO, EL CRUCE DE TOPPING_ID CON EXTRAS Y EXCLUSIONS ME DA EL SIGUIENTE ERROR: Numeric value '' is not recognized, QUE AUN NO HE CONSEGUIDO RESOLVER
