--¿Cuántos pedidos y cuántas pizzas se han entregado con éxito por cada runner, cuál es su porcentaje de éxito de cada runner? ¿qué porcentaje de las pizzas entregadas tenían modificaciones?



--número de pedidos que hace cada runner

   with A as ( select 
    NVL(count(order_id),0) as n_orders_total,
    runners.runner_id
    from runner_orders
    right join runners
    on runner_orders.runner_id=runners.runner_id
    group by runners.runner_id
    ),
--  número de pedidos con éxito cada runner  
B as (
select 
    count(order_id) as n_orders_exito,
    runner_id 
    from runner_orders 
    where cancellation <>'Customer Cancellation' and cancellation<>'Restaurant Cancellation' or cancellation is null
    group by runner_id
),
--número de pizzas de cada pedido
C as (
select
    count(pizza_id) as n_pizzas,
    customer_orders.order_id
    from customer_orders
    right join runner_orders
    on runner_orders.order_id=customer_orders.order_id
        where cancellation <>'Customer Cancellation' and cancellation<>'Restaurant Cancellation' or cancellation is null
    group by customer_orders.order_id
    ),
--número de pizzas modificadas de cada pedido final
D as (select 
    count(pizza_id) as n_pizzas_modificadas,
    runner_id
    from customer_orders
    left join runner_orders
    on customer_orders.order_id=runner_orders.order_id
    where (exclusions<>'null' and exclusions is not null and exclusions<>'' and extras<> 'null' and extras is not null and extras<>'')
    and (cancellation <>'Customer Cancellation' and cancellation<>'Restaurant Cancellation' or cancellation is not null)
    group by runner_id
    )

select 
(n_orders_exito/n_orders_total)*100 as porcentaje_exito,
NVL(n_orders_exito,0) as n_orders_exito,
n_orders_exito,
A.runner_id,
(n_pizzas_modificadas/sum(n_pizzas))*100 as porcentaje_pizzas_modificadas
from A
left join runner_orders
on runner_orders.runner_id=A.runner_id
left join B
on A.runner_id=B.runner_id
left join C
on runner_orders.order_id=C.order_id
left join D 
on runner_orders.runner_id=D.runner_id
group by A.runner_id, n_orders_exito, porcentaje_exito, n_pizzas_modificadas

/*********************************************************/
/***************** COMENTARIO MARÍA *********************/
/*********************************************************/
/* 

El resultado es por partes. Me falta una parte de la pregunta: número de pizzas que se han entregado con éxito.

Ese conteo ya lo tienes hecho en la tabla CTE que llamado como ''C'', 
solo tienes que sacarte al final como columna nueva la sumatoria de c.n_pizzas ---> sum(n_pizzas).

Pero cuidado!! Los porcentajes de pizzas modificadas no son del todo correcto porque no hemos tenido cuidado con una cosa:

Línea 42:  where exclusions<>'null' and exclusions is not null and exclusions<>'' and extras<> 'null' and extras is not null and extras<>''
    and cancellation <>'Customer Cancellation' and cancellation<>'Restaurant Cancellation' or cancellation is not null

Le estás diciendo que te filtre los resultados cuando ocurra esto:

- exclusions<>'null' and exclusions is not null and exclusions<>'' and extras<> 'null' and extras is not null and extras<>''
    and cancellation <>'Customer Cancellation' and cancellation<>'Restaurant Cancellation'
- Ó cuando ocurra 'Restaurant Cancellation' or cancellation is not null

Es decir, en el último OR, le estás diciendo a la máquina que el filtrado de exclusiones y extras no es obligarorio. Tienes que saber dilimitar las condiciones, que son,
filtrame cuando el campo "exclusiones" y "extras" no estén informados 
+ 
cuando el campo "cancellation" <>'Customer Cancellation' y <>'Restaurant Cancellation' Ó el campo "cancellation" no sea nulo

Entonces te falta poner un paréntesis entre las condiciones que te pongo antes del + y las condiciones que te pongo después del +.

Quedando la línea 42 así: where (exclusions<>'null' and exclusions is not null and exclusions<>'' and extras<> 'null' and extras is not null and extras<>'')
    and (cancellation <>'Customer Cancellation' and cancellation<>'Restaurant Cancellation' or cancellation is not null)


*/

///////////corregido///////////
