--DÍA 2
--Para cada mes, ¿Cuántos clientes realizan más de 1 depósito y 1 compra ó 1 retiro en un solo mes?
with A as (
select 
    customer_id,
    MONTH(txn_date) as month,
    txn_type,
    txn_amount
from customer_transactions
order by customer_id, month
),
n_withdrawal as (
select 
    customer_id,
    month,
    txn_type,
    count(txn_type) as n_withdrawal
from A
where txn_type='withdrawal' 
group by customer_id, month, txn_type
order by customer_id, month
),
clientes_withdrawal as(
select 
    distinct customer_id, 
    month
from n_withdrawal
where n_withdrawal>1
),
n_deposit as (
select 
    customer_id,
    month,
    txn_type,
    count(txn_type) as n_deposit
from A
where txn_type='deposit' 
group by customer_id, month, txn_type
order by customer_id, month
),
clientes_deposit as(
select 
    distinct customer_id,
    month
    
from n_deposit
where n_deposit>1
),
n_purchase as (
select
    customer_id,
    month,
    txn_type,
    count(txn_type) as n_purchase
from A 
where txn_type='purchase' 
group by customer_id, month, txn_type
order by customer_id, month 
),
clientes_purchase_deposit as (
select 
    distinct clientes_deposit.customer_id,
    clientes_deposit.month
    
from clientes_deposit
inner join n_purchase
on clientes_deposit.customer_id=n_purchase.customer_id
where n_purchase>1
),
clientes_total as (
select
    clientes_withdrawal.customer_id,
    clientes_withdrawal.month
from  clientes_withdrawal
full join clientes_purchase_deposit
on clientes_withdrawal.customer_id=clientes_purchase_deposit.customer_id
)
select count(customer_id),
clientes_total.month
from clientes_total where customer_id is not null group by month
;

/*********************************************************/
/***************** COMENTARIO MARÍA *********************/
/*********************************************************/
/* 

Hola Laura! El resultado no es correcto.

Lo haces muy lioso. Se está liando el conteo a la hora de hacer el conteo, aparte los full join son muy peligrosos. No se sabe qué estás contando de más o de menos.

Es más sencillo de como lo planteas. Te planteo empezar de 0 y en una misma consulta sacar 3 contadores por cliente.
Si estamos ante un TXN_TYPE = 'deposit' ponemos 1 y si no 0, esto es el indicador de depósitos. Luego sumas por cliente.

Algo así:

SELECT MONTHNAME(TXN_DATE) AS MES
		,EXTRACT(YEAR FROM TXN_DATE) AS ANIO
		,CUSTOMER_ID
		,SUM(CASE 
				WHEN TXN_TYPE = 'deposit'
					THEN 1
				ELSE 0
				END) NUM_DEPOSIT
		,SUM(CASE 
				WHEN TXN_TYPE = 'purchase'
					THEN 1
				ELSE 0
				END) NUM_PURCHASE
		,SUM(CASE 
				WHEN TXN_TYPE = 'withdrawal'
					THEN 1
				ELSE 0
				END) NUM_withdrawal
	FROM CUSTOMER_TRANSACTIONS
	GROUP BY CUSTOMER_ID
		,MES
		,ANIO;

Una vez sacasda esta información solo tienes que sumar aquellos clientes que:
(
NUM_DEPOSIT > 1
AND NUM_PURCHASE > 1
)
OR NUM_withdrawal > 1

*/

